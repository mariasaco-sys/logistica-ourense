import streamlit as st
import pandas as pd
import folium
from folium.features import DivIcon
from streamlit_folium import st_folium
from geopy.distance import geodesic
from geopy.geocoders import Nominatim
import requests
import time
import io

# --- CONFIGURACI√ìN DE LA P√ÅGINA ---
st.set_page_config(page_title="Log√≠stica Ourense Pro", layout="wide")

st.title("üöõ Calculadora Log√≠stica (Datos Reales)")
st.markdown("Calcula rutas y asigna d√≠as de reparto seg√∫n tu hist√≥rico de pedidos.")

# --- 0. DATOS HIST√ìRICOS (INCRUSTADOS) ---
# Aqu√≠ he pegado los datos que me has pasado para que funcionen sin subir excel
CSV_DATA = """Ruta_Asignada,C√≥digo postal env√≠o,Ciudad_Clean,Num_Pedidos_Historico,Dia_Asignado
EJE ESTE (N-120),27400,MONFORTE DE LEMOS,29,Jueves
EJE ESTE (N-120),27500,CHANTADA,15,Jueves
EJE ESTE (N-120),32720,ESGOS,10,Jueves
EJE ESTE (N-120),32700,MACEDA,9,Jueves
EJE ESTE (N-120),27513,CHANTADA,7,Jueves
EJE ESTE (N-120),32706,MACEDA,6,Jueves
EJE ESTE (N-120),32760,CASTRO CALDELAS,5,Jueves
EJE ESTE (N-120),27400,MONFORTE,4,Jueves
EJE ESTE (N-120),32780,PUEBLA DE TRIVES,4,Jueves
EJE ESTE (N-120),27514,CHANTADA,3,Jueves
EJE ESTE (N-120),27320,"QUIROGA , MONFORTE",2,Jueves
EJE ESTE (N-120),27400,MONFORTE DE LEMOS CASCO URBANO,2,Jueves
EJE ESTE (N-120),27500,CHANTADA LUGO,2,Jueves
EJE ESTE (N-120),27517,CHANTADA,2,Jueves
EJE ESTE (N-120),27590,MONFORTE DE LEMOS,2,Jueves
EJE ESTE (N-120),32315,O BARCO DE VALDEORRAS,2,Jueves
EJE ESTE (N-120),32350,A RUA,2,Jueves
EJE ESTE (N-120),32766,CASTRO CALDELAS,2,Jueves
EJE ESTE (N-120),32769,CASTRO CALDELAS,2,Jueves
EJE ESTE (N-120),27400,MONFORTE DE LEMOS (GULLADE ),1,Jueves
EJE ESTE (N-120),27410,MONFORTE DE LEMOS,1,Jueves
EJE ESTE (N-120),27417,MONFORTE DE LEMOS,1,Jueves
EJE ESTE (N-120),27420,MONFORTE DE LEMOS,1,Jueves
EJE ESTE (N-120),27420,PI√ëEIRA SAN MARTI√ëO MONFORTE,1,Jueves
EJE ESTE (N-120),27512,LAXE XOANIN - CHANTADA,1,Jueves
EJE ESTE (N-120),27513,REQUEIXO CHANTADA,1,Jueves
EJE ESTE (N-120),27519,CHANTADA,1,Jueves
EJE ESTE (N-120),27595,CHANTADA,1,Jueves
EJE ESTE (N-120),32002,CHANTADA,1,Jueves
EJE ESTE (N-120),32300,"BARCO, O",1,Jueves
EJE ESTE (N-120),32300,O BARCO,1,Jueves
EJE ESTE (N-120),32300,O BARCO DE VALDEORRAS,1,Jueves
EJE ESTE (N-120),32350,A RUA DE VALDEORRAS,1,Jueves
EJE ESTE (N-120),32357,ROBLIDO A RUA,1,Jueves
EJE ESTE (N-120),32700,CASTRO CALDELAS,1,Jueves
EJE ESTE (N-120),32700,ORENSE MACEDA,1,Jueves
EJE ESTE (N-120),32708,MACEDA,1,Jueves
EJE ESTE (N-120),32720,GOMARIZ ESGOS,1,Jueves
EJE ESTE (N-120),32740,MACEDA,1,Jueves
EJE ESTE (N-120),32794,CASTRO CALDELAS,1,Jueves
EJE NORTE (AG-53/A-52),32500,O CARBALLI√ëO,36,Martes
EJE NORTE (AG-53/A-52),32400,RIBADAVIA,15,Martes
EJE NORTE (AG-53/A-52),32520,AVION,10,Martes
EJE NORTE (AG-53/A-52),36500,LALIN,10,Martes
EJE NORTE (AG-53/A-52),32500,"CARBALLI√ëO, O",7,Martes
EJE NORTE (AG-53/A-52),32130,SAN CRISTOVO DE CEA,6,Martes
EJE NORTE (AG-53/A-52),32420,LEIRO,6,Martes
EJE NORTE (AG-53/A-52),32426,LEIRO,3,Martes
EJE NORTE (AG-53/A-52),32570,MASIDE,3,Martes
EJE NORTE (AG-53/A-52),32418,RIBADAVIA,2,Martes
EJE NORTE (AG-53/A-52),32419,"VIEITE, LEIRO",2,Martes
EJE NORTE (AG-53/A-52),32420,LEBOSENDE- LEIRO,2,Martes
EJE NORTE (AG-53/A-52),32428,LEIRO,2,Martes
EJE NORTE (AG-53/A-52),32573,MASIDE,2,Martes
EJE NORTE (AG-53/A-52),36512,LALIN,2,Martes
EJE NORTE (AG-53/A-52),15172,OLEIROS,1,Martes
EJE NORTE (AG-53/A-52),15176,OLEIROS,1,Martes
EJE NORTE (AG-53/A-52),32139,BOBORAS,1,Martes
EJE NORTE (AG-53/A-52),32141,CEA,1,Martes
EJE NORTE (AG-53/A-52),32141,SAN CRISTOBAL DE CEA,1,Martes
EJE NORTE (AG-53/A-52),32141,SAN CRISTOBO DE CEA,1,Martes
EJE NORTE (AG-53/A-52),32141,SAN CRISTOVO DE CEA,1,Martes
EJE NORTE (AG-53/A-52),32410,MELON,1,Martes
EJE NORTE (AG-53/A-52),32411,MELON,1,Martes
EJE NORTE (AG-53/A-52),32415,RIBADAVIA,1,Martes
EJE NORTE (AG-53/A-52),32415,VENTOSELA (RIBADAVIA ),1,Martes
EJE NORTE (AG-53/A-52),32416,RIBADAVIA,1,Martes
EJE NORTE (AG-53/A-52),32416,"SAN CRISTOBAL, RIBADAVIA",1,Martes
EJE NORTE (AG-53/A-52),32418,FRANCELOS - RIBADAVIA,1,Martes
EJE NORTE (AG-53/A-52),32418,SAMPAIO RIBADAVIA,1,Martes
EJE NORTE (AG-53/A-52),32418,"SANPAIO, RIBADAVIA",1,Martes
EJE NORTE (AG-53/A-52),32420,O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32425,LEIRO,1,Martes
EJE NORTE (AG-53/A-52),32429,LEIRO,1,Martes
EJE NORTE (AG-53/A-52),32500,CARBALLI√ëO - ARCOS,1,Martes
EJE NORTE (AG-53/A-52),32500,CONCELLO DE CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32500,MAGARI√ëOS-O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32510,O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32514,"ALBARELLOS,BOBORAS",1,Martes
EJE NORTE (AG-53/A-52),32514,BOBORAS,1,Martes
EJE NORTE (AG-53/A-52),32514,BOBORAS VILACHA CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32515,O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32515,PARTOVIA - O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32520,"BARROSO, DE AVION",1,Martes
EJE NORTE (AG-53/A-52),32534,O CARBALLI√ëO,1,Martes
EJE NORTE (AG-53/A-52),32570,O LAGO MASIDE,1,Martes
EJE NORTE (AG-53/A-52),32573,CONCELLO DE MASIDE,1,Martes
EJE NORTE (AG-53/A-52),32574,MASIDE,1,Martes
EJE NORTE (AG-53/A-52),32577,"LOUREDO, MASIDE",1,Martes
EJE NORTE (AG-53/A-52),36510,LALIN,1,Martes
EJE NORTE (AG-53/A-52),36540,SILLEDA,1,Martes
EJE SUR (A-52),32630,XINZO DE LIMIA,28,Mi√©rcoles
EJE SUR (A-52),32600,VERIN,26,Mi√©rcoles
EJE SUR (A-52),32660,ALLARIZ,25,Mi√©rcoles
EJE SUR (A-52),32112,PADERNE DE ALLARIZ,12,Mi√©rcoles
EJE SUR (A-52),32670,XUNQUEIRA DE AMBIA,8,Mi√©rcoles
EJE SUR (A-52),32664,ALLARIZ,6,Mi√©rcoles
EJE SUR (A-52),32667,ALLARIZ,6,Mi√©rcoles
EJE SUR (A-52),32692,SANDIAS,6,Mi√©rcoles
EJE SUR (A-52),32668,ALLARIZ,5,Mi√©rcoles
EJE SUR (A-52),32870,LOBIOS,5,Mi√©rcoles
EJE SUR (A-52),32610,RIOS,4,Mi√©rcoles
EJE SUR (A-52),32892,LOBIOS,4,Mi√©rcoles
EJE SUR (A-52),32637,XINZO DE LIMIA,3,Mi√©rcoles
EJE SUR (A-52),32665,ALLARIZ,3,Mi√©rcoles
EJE SUR (A-52),32678,XUNQUEIRA DE AMBIA,3,Mi√©rcoles
EJE SUR (A-52),32689,CUALEDRO,3,Mi√©rcoles
EJE SUR (A-52),32695,TRASMIRAS,3,Mi√©rcoles
EJE SUR (A-52),27423,LOBIOS,2,Mi√©rcoles
EJE SUR (A-52),32627,TINTORES VERIN,2,Mi√©rcoles
EJE SUR (A-52),32632,XINZO DE LIMIA,2,Mi√©rcoles
EJE SUR (A-52),32636,XINZO DE LIMIA MORGADE,2,Mi√©rcoles
EJE SUR (A-52),32650,XINZO VILAR DE SANTOS,2,Mi√©rcoles
EJE SUR (A-52),32678,CONCELLO DE XUNQUEIRA DE AMBIA,2,Mi√©rcoles
EJE SUR (A-52),32680,CUALEDRO,2,Mi√©rcoles
EJE SUR (A-52),32688,CUALEDRO,2,Mi√©rcoles
EJE SUR (A-52),32895,LOBIOS,2,Mi√©rcoles
EJE SUR (A-52),32111,PADERNE ALLARIZ,1,Mi√©rcoles
EJE SUR (A-52),32111,PADERNE DE ALLARIZ,1,Mi√©rcoles
EJE SUR (A-52),32111,SANCRISTVO PADERNE DE ALLARIZ,1,Mi√©rcoles
EJE SUR (A-52),32112,PDERNE DE ALLARIZ,1,Mi√©rcoles
EJE SUR (A-52),32525,ALLARIZ DOADE,1,Mi√©rcoles
EJE SUR (A-52),32610,COVELAS RIOS,1,Mi√©rcoles
EJE SUR (A-52),32611,RIOS,1,Mi√©rcoles
EJE SUR (A-52),32611,VERIN,1,Mi√©rcoles
EJE SUR (A-52),32614,VERIN,1,Mi√©rcoles
EJE SUR (A-52),32618,MEDEIROS MONTERREI,1,Mi√©rcoles
EJE SUR (A-52),32618,MONTERREI,1,Mi√©rcoles
EJE SUR (A-52),32618,VERIN,1,Mi√©rcoles
EJE SUR (A-52),32618,VILLAZA DE MONTERREI,1,Mi√©rcoles
EJE SUR (A-52),32619,CONCELLO DE MONTERREI,1,Mi√©rcoles
EJE SUR (A-52),32630,XINZO,1,Mi√©rcoles
EJE SUR (A-52),32631,XINZO DE LIMIA,1,Mi√©rcoles
EJE SUR (A-52),32635,XINZO DE LIMIA,1,Mi√©rcoles
EJE SUR (A-52),32636,XINZO DE LIMIA,1,Mi√©rcoles
EJE SUR (A-52),32646,"XINZO , BALTAR",1,Mi√©rcoles
EJE SUR (A-52),32655,XINZO,1,Mi√©rcoles
EJE SUR (A-52),32664,"PENAMA, ALLARIZ",1,Mi√©rcoles
EJE SUR (A-52),32667,REQUEIXO DE VALVERDE / ALLARIZ,1,Mi√©rcoles
EJE SUR (A-52),32670,XINZO DE LIMIA,1,Mi√©rcoles
EJE SUR (A-52),32679,XUNQUEIRA DE AMBIA,1,Mi√©rcoles
EJE SUR (A-52),32680,BALDRIZ - CONCELLO DE CUALEDRO .,1,Mi√©rcoles
EJE SUR (A-52),32688,PEDROSA CUALEDRO,1,Mi√©rcoles
EJE SUR (A-52),32689,CARZOA CUALEDRO,1,Mi√©rcoles
EJE SUR (A-52),32696,"LOGOSELO, SARREAUS ,XINZO DE LIMIA",1,Mi√©rcoles
EJE SUR (A-52),32696,TRASMIRAS,1,Mi√©rcoles
EJE SUR (A-52),32730,XUNQUEIRA DE AMBIA,1,Mi√©rcoles
EJE SUR (A-52),32750,XUNQUEIRA DE AMBIA,1,Mi√©rcoles
EJE SUR (A-52),32840,LOBIOS,1,Mi√©rcoles
EJE SUR (A-52),32869,LOBIOS,1,Mi√©rcoles
EJE SUR (A-52),32890,LOBIOS,1,Mi√©rcoles
EJE SUR (A-52),32892,XENDIVE (LOBIOS),1,Mi√©rcoles
ZONA METRO,32005,OURENSE,162,Lun y Vie
ZONA METRO,32001,OURENSE,135,Lun y Vie
ZONA METRO,32002,OURENSE,105,Lun y Vie
ZONA METRO,32004,OURENSE,89,Lun y Vie
ZONA METRO,32003,OURENSE,44,Lun y Vie
ZONA METRO,32890,BARBADAS,15,Lun y Vie
ZONA METRO,32911,SAN CIBRAO DAS VI√ëAS,13,Lun y Vie
ZONA METRO,32710,PEREIRO DE AGUIAR,12,Lun y Vie
ZONA METRO,32170,AMOEIRO,10,Lun y Vie
ZONA METRO,32792,PEREIRO DE AGUIAR,8,Lun y Vie
ZONA METRO,32830,A MERCA,7,Lun y Vie
ZONA METRO,32910,SAN CIBRAO DAS VI√ëAS,7,Lun y Vie
ZONA METRO,32172,AMOEIRO,6,Lun y Vie
ZONA METRO,32793,PEREIRO DE AGUIAR,6,Lun y Vie
ZONA METRO,32930,TOEN,6,Lun y Vie
ZONA METRO,32980,AMOEIRO,6,Lun y Vie
ZONA METRO,32002,BARBADAS,5,Lun y Vie
ZONA METRO,32152,COLES,5,Lun y Vie
ZONA METRO,32100,COLES,4,Lun y Vie
ZONA METRO,32710,CORTI√ëAS PEREIRO DE AGUIAR,4,Lun y Vie
ZONA MET

